vmType: "vz"
os: "Linux"
arch: "default"

images:
  - location: "https://channels.nixos.org/nixos-24.05/latest-nixos-minimal-x86_64-linux.iso"
    arch: "x86_64"
  - location: "https://channels.nixos.org/nixos-24.05/latest-nixos-minimal-aarch64-linux.iso"
    arch: "aarch64"

cpus: 4
memory: "8GiB"
disk: "100GiB"

containerd:
  system: false
  user: false

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # NixOS system configuration setup
      # Clone the nix-config repository
      if [ ! -d /etc/nixos/nix-config ]; then
        git clone https://github.com/bromanko/nix-config.git /etc/nixos/nix-config
      fi

      # Link the lima-dev configuration
      ln -sf /etc/nixos/nix-config/hosts/nixos/lima-dev/default.nix /etc/nixos/configuration.nix
      ln -sf /etc/nixos/nix-config/hosts/nixos/lima-dev/hardware-configuration.nix /etc/nixos/hardware-configuration.nix

      # Build and switch to the new configuration
      nixos-rebuild switch

      # Set up user-editable Privoxy configuration
      cp /etc/privoxy/user.action.template /var/lib/privoxy/user.action
      chown privoxy:privoxy /var/lib/privoxy/user.action
      systemctl restart privoxy

      # Add hostname to /etc/hosts to prevent sudo warnings
      HOSTNAME=$(hostname)
      if ! grep -q "127.0.1.1.*$HOSTNAME" /etc/hosts; then
        echo "127.0.1.1 $HOSTNAME" >> /etc/hosts
      fi

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Install Nix
      if [ ! -d ~/.nix-profile ]; then
        curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --no-confirm
      fi

      # User setup is handled by home-manager in the NixOS configuration
      echo "NixOS lima-dev setup complete"
      echo "Privoxy is running on port 8118"
      echo "Edit /var/lib/privoxy/user.action to manage allowed domains"
      echo "Restart privoxy after editing: sudo systemctl restart privoxy"

      # Source nix environment
      . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh

      # Build and activate home-manager configuration
      nix build github:bromanko/nix-config#homeManagerConfigurations.lima-dev.activationPackage
      ./result/activate

      echo "Home-manager activated successfully"

ssh:
  loadDotSSHPubKeys: true
  forwardAgent: true
