vmType: "vz"
os: "Linux"
arch: "default"

images:
  - location: "https://github.com/nixos-lima/nixos-lima/releases/download/v0.0.3/nixos-lima-v0.0.3-aarch64.qcow2"
    arch: "aarch64"
    digest: "sha512:809bd6bf46e27719eb69cc248e31a6c98725415976f8f0111b86228148a4379ea05e7405930c086487c9d51961e8776f61744175f33423ce3508e74a7f1a87c4"
  - location: "https://github.com/nixos-lima/nixos-lima/releases/download/v0.0.3/nixos-lima-v0.0.3-x86_64.qcow2"
    arch: "x86_64"
    digest: "sha512:d7e6a9c9519d94e006af40f689b98c235624bcc5c32f13ad4fe6c6ae411db4a1d6f5415135cd06665fc6eccd4c857d64512c28ec76cd04bfdfbd791408c57eb6"

cpus: 4
memory: "8GiB"
disk: "100GiB"

# No host mounts â€” full isolation between host and guest.
# Code is cloned independently inside the VM.
mounts: []

containerd:
  system: false
  user: false

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Clone nix-config if not already present
      if [ ! -d /etc/nixos/nix-config ]; then
        git clone https://github.com/bromanko/nix-config.git /etc/nixos/nix-config
      fi

      # Rebuild with the NixOS flake configuration
      cd /etc/nixos/nix-config
      nixos-rebuild switch --flake .#lima-nixos-dev

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Set up user Code directory with nix-config clone
      mkdir -p ~/Code
      if [ ! -d ~/Code/nix-config ]; then
        git clone https://github.com/bromanko/nix-config.git ~/Code/nix-config
      fi

      echo "NixOS lima-nixos-dev setup complete"
      echo "Rebuild with: sudo nixos-rebuild switch --flake ~/Code/nix-config#lima-nixos-dev"

portForwards:
  - guestPortRange: [1024, 65535]
    hostPortRange: [1024, 65535]

ssh:
  loadDotSSHPubKeys: true
  forwardAgent: true
